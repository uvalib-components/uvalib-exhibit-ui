<link rel="import" href="../uvalib-theme/uvalib-ui-element.html">
<link rel="import" href="../uva-models/uva-library.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../uvalib-theme/uvalib-theme.html">
<link rel="import" href="../uvalib-helper-libs/uvalib-helper-libs.html">

<dom-module id="uvalib-exhibits">
  <template>
    <uva-library path="exhibits" items="{{_exhibits}}" sort-by="date" sort-order="desc"></uva-library>
  </template>

  <script>
    /**
     * `uvalib-exhibits`
     * component to select some exhibits based on a category
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UvalibExhibits extends UvaLibUiElement {
      static get is() { return 'uvalib-exhibits'; }
      static get properties() {
        return {
          mainExhibit: {
            type: Boolean,
            value: false
          },
          category: {
            type: String,
            value: 'current'
          },
          limit: {
            type: Number,
            value: 1
          },
          imageUrl: {
            type: String,
            value: 'relative'
          },
          exhibits: {
            type: Array,
            reflectToAttribute: true
          },
          _exhibits: {
            type: Array
          }
        };
      }
      static get observers() {
        return [
          '_updateFilter(mainExhibit,category,limit)'
        ]
      }

      _updateFilter(mainExhibit,category,limit) {
        // This feature assumes just one exhibit is to be returned in the array
        if (mainExhibit) {
          this.exhibits = _.filter(this._exhibits, {'mainExhibit': true});
          // if no main exhibit found then get the latest current exhibit
          if (!this.exhibits.length) {
            var ex = _.find(this._exhibits, function(e) { return (_.find(e.exhibitStatus, {'value': 'current'})) ? true : false; });
            // if no current exhibit then get the latest exhibit
            if (!ex) {
              ex = this._exhibits.pop();
            }
            this.exhibits.push(ex);
          }
        } else {
          this.exhibits = [];
          var exs = _.filter(this._exhibits, function(e) { return (_.find(e.exhibitStatus, {'value': category})) ? true : false; });
          for (var i=0; i < limit; i++) {
            this.exhibits.push(exs[i]);
          }
        }
        this.exhibits.foreach(function(x) {
          if (this.imageUrl == 'relative') {
            x.image.url = super.whichImage(img.replace('https://wwwstatic.lib.virginia.edu','').replace('https://drupal.lib.virginia.edu/sites/default',''));
          } else {
            x.image.url = super.whichImage(img);
          }
        });
      }
    }

    window.customElements.define(UvalibExhibits.is, UvalibExhibits);
  </script>
</dom-module>
